// MiniPaint Pro - Prisma Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// User (Phase 2)
// ============================================
model User {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String
  displayName   String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  armies        Army[]
  miniatures    Miniature[]
  paints        UserPaint[]
  recipes       Recipe[]
  savedRecipes  SavedRecipe[]
  progress      UserProgress?

  @@map("users")
}

// ============================================
// Army
// ============================================
model Army {
  id           String     @id @default(uuid())
  userId       String?
  name         String
  faction      String
  gameSystem   GameSystem @default(WARHAMMER_40K)
  targetPoints Int
  iconEmoji    String?
  colorHex     String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  user         User?       @relation(fields: [userId], references: [id], onDelete: Cascade)
  miniatures   Miniature[]

  @@map("armies")
}

enum GameSystem {
  WARHAMMER_40K
  AGE_OF_SIGMAR
  KILL_TEAM
  NECROMUNDA
  HORUS_HERESY
  OTHER
}

// ============================================
// Miniature
// ============================================
model Miniature {
  id         String           @id @default(uuid())
  userId     String?
  armyId     String?
  name       String
  faction    String
  points     Int
  modelCount Int              @default(1)
  status     MiniatureStatus  @default(UNBUILT)
  cost       Decimal?         @db.Decimal(10, 2)
  notes      String?
  imageUrl   String?
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  user       User?  @relation(fields: [userId], references: [id], onDelete: Cascade)
  army       Army?  @relation(fields: [armyId], references: [id], onDelete: SetNull)

  @@map("miniatures")
}

enum MiniatureStatus {
  UNBUILT
  ASSEMBLED
  PRIMED
  WIP
  PAINTED
  COMPLETE
}

// ============================================
// Paint
// ============================================
model Paint {
  id           String     @id @default(uuid())
  name         String
  brand        PaintBrand
  type         PaintType
  colorHex     String
  isOfficial   Boolean    @default(true)
  createdAt    DateTime   @default(now())

  userPaints   UserPaint[]
  recipeSteps  RecipeStep[]
  equivalentTo PaintEquivalent[] @relation("EquivalentTo")
  equivalents  PaintEquivalent[] @relation("EquivalentFrom")

  @@unique([name, brand])
  @@map("paints")
}

model UserPaint {
  id        String   @id @default(uuid())
  userId    String?
  paintId   String
  owned     Boolean  @default(false)
  wishlist  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User?  @relation(fields: [userId], references: [id], onDelete: Cascade)
  paint     Paint @relation(fields: [paintId], references: [id], onDelete: Cascade)

  @@unique([userId, paintId])
  @@map("user_paints")
}

model PaintEquivalent {
  id            String @id @default(uuid())
  paintId       String
  equivalentId  String

  paint         Paint @relation("EquivalentFrom", fields: [paintId], references: [id], onDelete: Cascade)
  equivalent    Paint @relation("EquivalentTo", fields: [equivalentId], references: [id], onDelete: Cascade)

  @@unique([paintId, equivalentId])
  @@map("paint_equivalents")
}

enum PaintBrand {
  CITADEL
  VALLEJO
  ARMY_PAINTER
  SCALE75
  AK_INTERACTIVE
  TURBO_DORK
  OTHER
}

enum PaintType {
  BASE
  LAYER
  SHADE
  CONTRAST
  TECHNICAL
  DRY
  AIR
  METALLIC
}

// ============================================
// Recipe
// ============================================
model Recipe {
  id              String           @id @default(uuid())
  userId          String?
  authorName      String
  name            String
  difficulty      RecipeDifficulty
  timeMinutes     Int
  previewColorHex String
  rating          Decimal          @default(0) @db.Decimal(2, 1)
  ratingCount     Int              @default(0)
  tags            String[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  user            User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  steps           RecipeStep[]
  savedBy         SavedRecipe[]

  @@map("recipes")
}

model RecipeStep {
  id          String  @id @default(uuid())
  recipeId    String
  order       Int
  instruction String
  paintId     String?
  technique   String?
  imageUrl    String?

  recipe      Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  paint       Paint? @relation(fields: [paintId], references: [id], onDelete: SetNull)

  @@map("recipe_steps")
}

model SavedRecipe {
  id        String   @id @default(uuid())
  userId    String?
  recipeId  String
  savedAt   DateTime @default(now())

  user      User?   @relation(fields: [userId], references: [id], onDelete: Cascade)
  recipe    Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@unique([userId, recipeId])
  @@map("saved_recipes")
}

enum RecipeDifficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

// ============================================
// Progress & Gamification
// ============================================
model UserProgress {
  id                  String   @id @default(uuid())
  visitorId           String?  @unique
  userId              String?  @unique
  currentStreak       Int      @default(0)
  bestStreak          Int      @default(0)
  lastPaintedDate     DateTime?
  totalModelsPainted  Int      @default(0)
  totalHoursPainted   Decimal  @default(0) @db.Decimal(10, 2)
  updatedAt           DateTime @updatedAt

  user                User?              @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievements        UserAchievement[]
  goals               UserGoal[]
  events              UserEvent[]

  @@map("user_progress")
}

model Achievement {
  id              String @id @default(uuid())
  emoji           String
  name            String @unique
  description     String
  requirementType String
  requirementValue Int

  userAchievements UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  id            String   @id @default(uuid())
  progressId    String
  achievementId String
  unlockedAt    DateTime @default(now())

  progress      UserProgress @relation(fields: [progressId], references: [id], onDelete: Cascade)
  achievement   Achievement  @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([progressId, achievementId])
  @@map("user_achievements")
}

model UserGoal {
  id           String   @id @default(uuid())
  progressId   String
  name         String
  type         GoalType
  targetValue  Int
  currentValue Int      @default(0)
  weekStart    DateTime
  weekEnd      DateTime

  progress     UserProgress @relation(fields: [progressId], references: [id], onDelete: Cascade)

  @@map("user_goals")
}

enum GoalType {
  MODELS
  HOURS
  CHARACTERS
  VEHICLES
}

model UserEvent {
  id           String   @id @default(uuid())
  progressId   String
  name         String
  eventDate    DateTime
  targetPoints Int
  armyId       String?
  notes        String?
  createdAt    DateTime @default(now())

  progress     UserProgress @relation(fields: [progressId], references: [id], onDelete: Cascade)

  @@map("user_events")
}
