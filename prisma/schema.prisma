// MiniPaint Pro - Prisma Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// User Role
// ============================================
enum UserRole {
  USER
  ADMIN
}

// ============================================
// User
// ============================================
model User {
  id                       String    @id @default(uuid())
  email                    String    @unique
  passwordHash             String
  displayName              String
  role                     UserRole  @default(USER)

  // Email verification
  emailVerified            Boolean   @default(false)
  emailVerificationToken   String?   @unique
  emailVerificationExpires DateTime?

  // Password reset
  passwordResetToken       String?   @unique
  passwordResetExpires     DateTime?

  // Account status
  isActive                 Boolean   @default(true)
  lastLoginAt              DateTime?

  createdAt                DateTime  @default(now())
  updatedAt                DateTime  @updatedAt

  // Relations
  refreshTokens            RefreshToken[]
  armies                   Army[]
  miniatures               Miniature[]
  paints                   UserPaint[]
  recipes                  Recipe[]
  savedRecipes             SavedRecipe[]
  progress                 UserProgress?
  unitTemplates            UnitTemplate[]
  preferences              UserPreferences?

  @@map("users")
}

// ============================================
// User Preferences
// ============================================
model UserPreferences {
  id                    String      @id @default(uuid())
  userId                String      @unique

  // Display preferences
  defaultGameSystem     GameSystem?
  defaultPaintBrand     PaintBrand?
  itemsPerPage          Int         @default(20)
  defaultViewMode       ViewMode    @default(GRID)

  // Dashboard preferences
  showCompletedMinis    Boolean     @default(true)
  defaultSortField      String      @default("updatedAt")
  defaultSortOrder      SortOrder   @default(DESC)

  // Notification preferences
  emailNotifications    Boolean     @default(true)
  streakReminders       Boolean     @default(true)

  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt

  user                  User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

enum ViewMode {
  GRID
  LIST
}

enum SortOrder {
  ASC
  DESC
}

// ============================================
// Refresh Token
// ============================================
model RefreshToken {
  id          String    @id @default(uuid())
  userId      String
  tokenHash   String    @unique
  userAgent   String?
  ipAddress   String?
  expiresAt   DateTime
  createdAt   DateTime  @default(now())
  revokedAt   DateTime?

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@map("refresh_tokens")
}

// ============================================
// Army
// ============================================
model Army {
  id                 String     @id @default(uuid())
  userId             String?
  name               String
  faction            String
  gameSystem         GameSystem @default(WARHAMMER_40K)
  targetPoints       Int
  iconEmoji          String?
  colorHex           String?
  backgroundImageUrl String?
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt

  user         User?       @relation(fields: [userId], references: [id], onDelete: Cascade)
  miniatures   Miniature[]

  @@map("armies")
}

enum GameSystem {
  WARHAMMER_40K
  AGE_OF_SIGMAR
  KILL_TEAM
  NECROMUNDA
  HORUS_HERESY
  OTHER
}

// ============================================
// Miniature
// ============================================
model Miniature {
  id              String           @id @default(uuid())
  userId          String?
  armyId          String?
  name            String
  faction         String
  gameSystem      GameSystem?
  unitId          String?
  wahapediaUrl    String?
  points          Int
  modelCount      Int              @default(1)
  modelsCompleted Int              @default(0)
  status          MiniatureStatus  @default(UNBUILT)

  // Multi-model stage tracking (JSON object with counts per stage)
  // Format: { "unbuilt": 1, "assembled": 0, "primed": 0, "wip": 0, "painted": 0, "complete": 0 }
  stageCounts     Json?

  // Substates for detailed tracking
  unbuiltState    UnbuiltState?    // For models in 'unbuilt' stage
  wipStage        WipStage?        // For models in 'wip' stage

  // Tags that apply to the entire unit
  tags            MiniatureTag[]   @default([])

  cost            Decimal?         @db.Decimal(10, 2)
  notes           String?
  imageUrl        String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  user        User?               @relation(fields: [userId], references: [id], onDelete: Cascade)
  army        Army?               @relation(fields: [armyId], references: [id], onDelete: SetNull)
  images      MiniatureImage[]
  colorScheme ColorScheme?
  tutorials   MiniatureTutorial[]

  @@map("miniatures")
}

enum MiniatureStatus {
  UNBUILT
  ASSEMBLED
  PRIMED
  WIP
  PAINTED
  COMPLETE
}

// Substates for UNBUILT status
enum UnbuiltState {
  INBOX       // Just received, unopened
  ON_SPRUE    // Still on the sprue/frame
  CLIPPED     // Off sprue, needs cleanup
  READY       // Ready to build
}

// Substates for WIP status (painting stages)
enum WipStage {
  BASE_COATED   // Base colors applied
  BLOCKING      // Blocking in main colors
  LAYERING      // Layering highlights
  WASHING       // Applying washes/shades
  HIGHLIGHTING  // Edge highlighting
  DETAILING     // Fine details
  BASING        // Base decoration
}

// Tags that can apply to any miniature regardless of status
enum MiniatureTag {
  MAGNETIZED       // Has magnets for swappable parts
  PINNED           // Has metal pins for stability
  SUB_ASSEMBLIES   // Built in sub-assemblies for easier painting
  BASED            // Base decoration done
  CONTRAST_METHOD  // Using contrast/speedpaint method
  VARNISHED        // Has protective varnish coat
  DECALS_APPLIED   // Transfers/decals done
  DISPLAY_QUALITY  // High quality display piece
  TABLETOP_READY   // Good enough for gaming
}

// ============================================
// Paint
// ============================================
model Paint {
  id           String     @id @default(uuid())
  name         String
  brand        PaintBrand
  type         PaintType
  colorHex     String
  isOfficial   Boolean    @default(true)
  createdAt    DateTime   @default(now())

  userPaints    UserPaint[]
  recipeSteps   RecipeStep[]
  equivalentTo  PaintEquivalent[] @relation("EquivalentTo")
  equivalents   PaintEquivalent[] @relation("EquivalentFrom")
  sectionPaints SectionPaint[]

  @@unique([name, brand])
  @@map("paints")
}

model UserPaint {
  id        String   @id @default(uuid())
  userId    String?
  paintId   String
  owned     Boolean  @default(false)
  wishlist  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User?  @relation(fields: [userId], references: [id], onDelete: Cascade)
  paint     Paint @relation(fields: [paintId], references: [id], onDelete: Cascade)

  @@unique([userId, paintId])
  @@map("user_paints")
}

model PaintEquivalent {
  id            String @id @default(uuid())
  paintId       String
  equivalentId  String

  paint         Paint @relation("EquivalentFrom", fields: [paintId], references: [id], onDelete: Cascade)
  equivalent    Paint @relation("EquivalentTo", fields: [equivalentId], references: [id], onDelete: Cascade)

  @@unique([paintId, equivalentId])
  @@map("paint_equivalents")
}

enum PaintBrand {
  CITADEL
  VALLEJO
  ARMY_PAINTER
  SCALE75
  AK_INTERACTIVE
  TURBO_DORK
  OTHER
}

enum PaintType {
  BASE
  LAYER
  SHADE
  CONTRAST
  TECHNICAL
  DRY
  AIR
  METALLIC
}

// ============================================
// Recipe
// ============================================
model Recipe {
  id              String           @id @default(uuid())
  userId          String?
  authorName      String
  name            String
  difficulty      RecipeDifficulty
  timeMinutes     Int
  previewColorHex String
  rating          Decimal          @default(0) @db.Decimal(2, 1)
  ratingCount     Int              @default(0)
  tags            String[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  user            User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  steps           RecipeStep[]
  savedBy         SavedRecipe[]

  @@map("recipes")
}

model RecipeStep {
  id          String  @id @default(uuid())
  recipeId    String
  order       Int
  instruction String
  paintId     String?
  technique   String?
  imageUrl    String?

  recipe      Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  paint       Paint? @relation(fields: [paintId], references: [id], onDelete: SetNull)

  @@map("recipe_steps")
}

model SavedRecipe {
  id        String   @id @default(uuid())
  userId    String?
  recipeId  String
  savedAt   DateTime @default(now())

  user      User?   @relation(fields: [userId], references: [id], onDelete: Cascade)
  recipe    Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@unique([userId, recipeId])
  @@map("saved_recipes")
}

enum RecipeDifficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

// ============================================
// Progress & Gamification
// ============================================
model UserProgress {
  id                  String   @id @default(uuid())
  visitorId           String?  @unique
  userId              String?  @unique
  currentStreak       Int      @default(0)
  bestStreak          Int      @default(0)
  lastPaintedDate     DateTime?
  totalModelsPainted  Int      @default(0)
  totalHoursPainted   Decimal  @default(0) @db.Decimal(10, 2)
  updatedAt           DateTime @updatedAt

  user                User?              @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievements        UserAchievement[]
  goals               UserGoal[]
  events              UserEvent[]

  @@map("user_progress")
}

model Achievement {
  id              String @id @default(uuid())
  emoji           String
  name            String @unique
  description     String
  requirementType String
  requirementValue Int

  userAchievements UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  id            String   @id @default(uuid())
  progressId    String
  achievementId String
  unlockedAt    DateTime @default(now())

  progress      UserProgress @relation(fields: [progressId], references: [id], onDelete: Cascade)
  achievement   Achievement  @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([progressId, achievementId])
  @@map("user_achievements")
}

model UserGoal {
  id           String   @id @default(uuid())
  progressId   String
  name         String
  type         GoalType
  targetValue  Int
  currentValue Int      @default(0)
  weekStart    DateTime
  weekEnd      DateTime

  progress     UserProgress @relation(fields: [progressId], references: [id], onDelete: Cascade)

  @@map("user_goals")
}

enum GoalType {
  MODELS
  HOURS
  CHARACTERS
  VEHICLES
}

model UserEvent {
  id           String   @id @default(uuid())
  progressId   String
  name         String
  eventDate    DateTime
  targetPoints Int
  armyId       String?
  notes        String?
  createdAt    DateTime @default(now())

  progress     UserProgress @relation(fields: [progressId], references: [id], onDelete: Cascade)

  @@map("user_events")
}

// ============================================
// Unit Images (Admin-managed)
// ============================================
model UnitImage {
  id           String     @id @default(uuid())
  gameSystem   GameSystem
  faction      String
  unitName     String
  filename     String
  originalName String
  mimeType     String
  size         Int
  source       ImageSource @default(MANUAL)
  sourceUrl    String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@unique([gameSystem, faction, unitName])
  @@map("unit_images")
}

enum ImageSource {
  MANUAL
  WARHAMMER_COMMUNITY
  GAMES_WORKSHOP
}

// ============================================
// Miniature Library
// ============================================

// Multiple images per miniature
model MiniatureImage {
  id           String             @id @default(uuid())
  miniatureId  String
  filename     String?            // null when using external URL
  originalName String?            // null when using external URL
  mimeType     String?            // null when using external URL
  size         Int?               // null when using external URL
  imageUrl     String?            // External URL (alternative to file upload)
  caption      String?
  imageType    MiniatureImageType @default(REFERENCE)
  order        Int                @default(0)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  miniature    Miniature @relation(fields: [miniatureId], references: [id], onDelete: Cascade)

  @@map("miniature_images")
}

enum MiniatureImageType {
  REFERENCE
  WIP
  COMPLETED
  DETAIL
}

// Color scheme with sections
model ColorScheme {
  id           String               @id @default(uuid())
  miniatureId  String               @unique
  name         String
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt

  miniature    Miniature            @relation(fields: [miniatureId], references: [id], onDelete: Cascade)
  sections     ColorSchemeSection[]

  @@map("color_schemes")
}

model ColorSchemeSection {
  id          String         @id @default(uuid())
  schemeId    String
  areaName    String
  order       Int            @default(0)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  scheme      ColorScheme    @relation(fields: [schemeId], references: [id], onDelete: Cascade)
  paints      SectionPaint[]

  @@map("color_scheme_sections")
}

model SectionPaint {
  id          String               @id @default(uuid())
  sectionId   String
  paintId     String
  order       Int                  @default(0)
  technique   String?
  notes       String?

  section     ColorSchemeSection   @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  paint       Paint                @relation(fields: [paintId], references: [id])

  @@map("section_paints")
}

// Tutorial videos
model MiniatureTutorial {
  id           String        @id @default(uuid())
  miniatureId  String
  title        String
  videoUrl     String
  platform     VideoPlatform @default(YOUTUBE)
  duration     Int?
  author       String?
  order        Int           @default(0)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  miniature    Miniature     @relation(fields: [miniatureId], references: [id], onDelete: Cascade)

  @@map("miniature_tutorials")
}

enum VideoPlatform {
  YOUTUBE
  VIMEO
  CUSTOM
}

// ============================================
// Unit Templates (for quick miniature add)
// ============================================
model UnitTemplate {
  id               String      @id @default(uuid())
  userId           String?
  name             String
  faction          String
  gameSystem       GameSystem
  defaultPoints    Int         @default(0)
  defaultModelCount Int        @default(1)
  wahapediaUnitId  String?
  wahapediaUrl     String?
  usageCount       Int         @default(0)
  lastUsedAt       DateTime?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  user             User?       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name, faction, gameSystem])
  @@index([userId])
  @@index([name])
  @@map("unit_templates")
}
